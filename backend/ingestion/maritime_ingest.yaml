# Maritime AIS Ingestion Pipeline (AISStream.io -> TAK Format -> Redpanda)
# Docs: https://aisstream.io/documentation
#
# Location is configured via ENV variables (set in docker-compose.yml):
#   BBOX_MIN_LAT, BBOX_MIN_LON, BBOX_MAX_LAT, BBOX_MAX_LON

input:
  websocket:
    url: "wss://stream.aisstream.io/v0/stream"
    # Send subscription message on connect with API key and bounding box
    open_message: |
      {
        "APIKey": "${AISSTREAM_API_KEY}",
        "BoundingBoxes": [
          [[${BBOX_MIN_LAT}, ${BBOX_MIN_LON}], [${BBOX_MAX_LAT}, ${BBOX_MAX_LON}]]
        ],
        "FilterMessageTypes": ["PositionReport"]
      }

pipeline:
  processors:
    # Parse the incoming JSON
    - mapping: |
        root = this

    # Filter for PositionReport messages only (skip metadata/errors)
    - mapping: |
        root = if this.MessageType == "PositionReport" { this } else { deleted() }

    # Transform to TAK-compatible JSON format
    - mapping: |
        let msg = this.Message.PositionReport
        let meta = this.MetaData

        root.uid = $meta.MMSI.string()
        root.type = "a-f-S-C-M"
        root.how = "m-g"
        root.time = now()
        root.start = now()
        root.stale = now().ts_add_iso8601("PT5M")

        root.point.lat = $msg.Latitude
        root.point.lon = $msg.Longitude
        root.point.hae = 0
        root.point.ce = 10.0
        root.point.le = 10.0

        root.detail.track.course = $msg.Cog.or(0)
        root.detail.track.speed = ($msg.Sog.or(0) * 0.514444)
        root.detail.contact.callsign = $meta.ShipName.or($meta.MMSI.string())

output:
  kafka:
    addresses: ["sovereign-redpanda:9092"]
    topic: "ais_raw"
    key: ${! json("uid") }
